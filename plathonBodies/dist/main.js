!function(m){"use strict";function s(t){return t*(Math.PI/180)}function d(t){return t*(180/Math.PI)}class D{constructor(i){if("object"==typeof i)if("object"==typeof i[0]){this.a=[];for(let s=0;s<4;s++){var a=[];if(void 0!==i[s])for(let t=0;t<4;t++)a[t]=void 0===i[s][t]?0:i[s][t];else for(let t=0;t<4;t++)a[t]=0;this.a[s]=a}}else{this.a=[];for(let s=0;s<4;s++){var e=[];for(let t=0;t<4;t++)e[t]=void 0===i[4*s+t]?0:i[4*s+t];this.a[s]=e}}else{this.a=[];for(let s=0;s<4;s++){var r=[];for(let t=0;t<4;t++)r[t]=void 0===arguments[4*s+t]?0:arguments[4*s+t];this.a[s]=r}}}mulMatr=a=>{var e=l();for(let i=0;i<4;i++)for(let s=0;s<4;s++)for(let t=0;t<4;t++)e.a[i][s]+=this.a[i][t]*a.a[t][s];return e};transpose=()=>{var i=l();for(let s=0;s<4;s++)for(let t=0;t<4;t++)i.a[s][t]=this.a[t][s];return i};determ=()=>this.a[0][0]*i(this.a[1][1],this.a[1][2],this.a[1][3],this.a[2][1],this.a[2][2],this.a[2][3],this.a[3][1],this.a[3][2],this.a[3][3])-this.a[0][1]*i(this.a[1][0],this.a[1][2],this.a[1][3],this.a[2][0],this.a[2][2],this.a[2][3],this.a[3][0],this.a[3][2],this.a[3][3])+this.a[0][2]*i(this.a[1][0],this.a[1][1],this.a[1][3],this.a[2][0],this.a[2][1],this.a[2][3],this.a[3][0],this.a[3][1],this.a[3][3])-this.a[0][3]*i(this.a[1][0],this.a[1][1],this.a[1][2],this.a[2][0],this.a[2][1],this.a[2][2],this.a[3][0],this.a[3][1],this.a[3][2]);inverse=()=>{var t,s=this.determ();return 0===s?h():((t=l()).a[0][0]=i(this.a[1][1],this.a[1][2],this.a[1][3],this.a[2][1],this.a[2][2],this.a[2][3],this.a[3][1],this.a[3][2],this.a[3][3])/s,t.a[1][0]=-i(this.a[1][0],this.a[1][2],this.a[1][3],this.a[2][0],this.a[2][2],this.a[2][3],this.a[3][0],this.a[3][2],this.a[3][3])/s,t.a[2][0]=i(this.a[1][0],this.a[1][1],this.a[1][3],this.a[2][0],this.a[2][1],this.a[2][3],this.a[3][0],this.a[3][1],this.a[3][3])/s,t.a[3][0]=-i(this.a[1][0],this.a[1][1],this.a[1][2],this.a[2][0],this.a[2][1],this.a[2][2],this.a[3][0],this.a[3][1],this.a[3][2])/s,t.a[0][1]=-i(this.a[0][1],this.a[0][2],this.a[0][3],this.a[2][1],this.a[2][2],this.a[2][3],this.a[3][1],this.a[3][2],this.a[3][3])/s,t.a[1][1]=+i(this.a[0][0],this.a[0][2],this.a[0][3],this.a[2][0],this.a[2][2],this.a[2][3],this.a[3][0],this.a[3][2],this.a[3][3])/s,t.a[2][1]=-i(this.a[0][0],this.a[0][1],this.a[0][3],this.a[2][0],this.a[2][1],this.a[2][3],this.a[3][0],this.a[3][1],this.a[3][3])/s,t.a[3][1]=+i(this.a[0][0],this.a[0][1],this.a[0][2],this.a[2][0],this.a[2][1],this.a[2][2],this.a[3][0],this.a[3][1],this.a[3][2])/s,t.a[0][2]=+i(this.a[0][1],this.a[0][2],this.a[0][3],this.a[1][1],this.a[1][2],this.a[1][3],this.a[3][1],this.a[3][2],this.a[3][3])/s,t.a[1][2]=-i(this.a[0][0],this.a[0][2],this.a[0][3],this.a[1][0],this.a[1][2],this.a[1][3],this.a[3][0],this.a[3][2],this.a[3][3])/s,t.a[2][2]=+i(this.a[0][0],this.a[0][1],this.a[0][3],this.a[1][0],this.a[1][1],this.a[1][3],this.a[3][0],this.a[3][1],this.a[3][3])/s,t.a[3][2]=-i(this.a[0][0],this.a[0][1],this.a[0][2],this.a[1][0],this.a[1][1],this.a[1][2],this.a[3][0],this.a[3][1],this.a[3][2])/s,t.a[0][3]=-i(this.a[0][1],this.a[0][2],this.a[0][3],this.a[1][1],this.a[1][2],this.a[1][3],this.a[2][1],this.a[2][2],this.a[2][3])/s,t.a[1][3]=+i(this.a[0][0],this.a[0][2],this.a[0][3],this.a[1][0],this.a[1][2],this.a[1][3],this.a[2][0],this.a[2][2],this.a[2][3])/s,t.a[2][3]=-i(this.a[0][0],this.a[0][1],this.a[0][3],this.a[1][0],this.a[1][1],this.a[1][3],this.a[2][0],this.a[2][1],this.a[2][3])/s,t.a[3][3]=+i(this.a[0][0],this.a[0][1],this.a[0][2],this.a[1][0],this.a[1][1],this.a[1][2],this.a[2][0],this.a[2][1],this.a[2][2])/s,t)}}function l(...t){return new D(...t)}function h(){return l([[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]])}function i(t,s,i,a,e,r,n,h,l){return t*e*l+s*r*n+i*a*h-t*r*h-s*a*l-i*e*n}function u(t){return l([[1,0,0,0],[0,1,0,0],[0,0,1,0],[t.x,t.y,t.z,1]])}function o(t){return l([[t.x,0,0,0],[0,t.y,0,0],[0,0,t.z,0],[0,0,0,1]])}function c(t){t=s(t);return l([[1,0,0,0],[0,Math.cos(t),Math.sin(t),0],[0,-Math.sin(t),Math.cos(t),0],[0,0,0,1]])}function w(t){t=s(t);return l([[Math.cos(t),0,-Math.sin(t),0],[0,1,0,0],[Math.sin(t),0,Math.cos(t),0],[0,0,0,1]])}function t(t){t=s(t);return l([[Math.cos(t),Math.sin(t),0,0],[-Math.sin(t),Math.cos(t),0,0],[0,0,1,0],[0,0,0,1]])}class F{constructor(t,s,i){void 0===t?this.x=this.y=this.z=0:"object"==typeof t?3===t.length?(this.x=t[0],this.y=t[1],this.z=t[2]):(this.x=t.x,this.y=t.y,this.z=t.z):void 0===s||void 0===i?this.x=this.y=this.z=t:(this.x=t,this.y=s,this.z=i)}add=t=>_(this.x+t.x,this.y+t.y,this.z+t.z);sub=t=>_(this.x-t.x,this.y-t.y,this.z-t.z);mulNum=t=>_(this.x*t,this.y*t,this.z*t);divNum=t=>_(this.x/t,this.y/t,this.z/t);neg=()=>_(-this.x,-this.y,-this.z);dot=t=>this.x*t.x+this.y*t.y+this.z*t.z;cross=t=>_(this.y*t.z-t.y*this.z,t.x*this.z-this.x*t.z,this.x*t.y-t.x*this.y);len2=()=>this.dot(this,this);len=()=>{var t=this.len2();return 0===t||1===t?t:Math.sqrt(t)};norm=()=>{var t=this.len();return this.divNum(t)};mulMatr=t=>{var s=this.x*t.a[0][3]+this.y*t.a[1][3]+this.z*t.a[2][3]+t.a[3][3];return _((this.x*t.a[0][0]+this.y*t.a[1][0]+this.z*t.a[2][0]+t.a[3][0])/s,(this.x*t.a[0][1]+this.y*t.a[1][1]+this.z*t.a[2][1]+t.a[3][1])/s,(this.x*t.a[0][2]+this.y*t.a[1][2]+this.z*t.a[2][2]+t.a[3][2])/s)};vecTransform=t=>_(this.x*t.a[0][0]+this.y*t.a[1][0]+this.z*t.a[2][0],this.x*t.a[0][1]+this.y*t.a[1][1]+this.z*t.a[2][1],this.x*t.a[0][2]+this.y*t.a[1][2]+this.z*t.a[2][2]);pointTransform=t=>_(this.x*t.a[0][0]+this.y*t.a[1][0]+this.z*t.a[2][0]+t.a[3][0],this.x*t.a[0][1]+this.y*t.a[1][1]+this.z*t.a[2][1]+t.a[3][1],this.x*t.a[0][2]+this.y*t.a[1][2]+this.z*t.a[2][2]+t.a[3][2])}function _(...t){return new F(...t)}class a{constructor(t,s){this.id=window.gl.createBuffer(),this.type=t,window.gl.bindBuffer(t,this.id),window.gl.bufferData(t,s,window.gl.STATIC_DRAW)}update(t){window.gl.bindBuffer(this.type,this.id),window.gl.bufferSubData(this.type,0,new Float32Array(t),0)}apply(){window.gl.bindBuffer(this.type,this.id)}free(){window.gl.deleteBuffer(this.id),this.id=null,this.size=0}}class L extends a{constructor(t){super(window.gl.ARRAY_BUFFER,44*t.length),this.numOfVertices=t.length,window.gl.bufferData(window.gl.ARRAY_BUFFER,new Float32Array(t),window.gl.STATIC_DRAW)}update(t){window.gl.bindBuffer(window.gl.ARRAY_BUFFER,this.id),window.gl.bufferSubData(window.gl.ARRAY_BUFFER,0,new Float32Array(t),0)}free(){super.free(),this.numOfVertices=0}}class q extends a{constructor(t){super(window.gl.ELEMENT_ARRAY_BUFFER,2*t.length),this.numOfIndices=t.length,window.gl.bufferData(window.gl.ELEMENT_ARRAY_BUFFER,new Uint32Array(t),window.gl.STATIC_DRAW)}update(t){window.gl.bindBuffer(window.gl.ELEMENT_ARRAY_BUFFER,this.id),window.gl.bufferSubData(window.gl.ELEMENT_ARRAY_BUFFER,0,new Uint32Array(t),0)}free(){super.free(),this.numOfIndices=0}}class g extends a{constructor(t,s,i){super(window.gl.UNIFORM_BUFFER,s),window.gl.bufferData(window.gl.UNIFORM_BUFFER,s,window.gl.STATIC_DRAW),this.name=t,this.bind=i}update(t){window.gl.bindBuffer(window.gl.UNIFORM_BUFFER,this.id),window.gl.bufferSubData(window.gl.UNIFORM_BUFFER,0,new Float32Array(t),0)}apply(t){var s=window.gl.getUniformBlockIndex(t,this.name);-1!==s&&4294967295!==s&&(window.gl.uniformBlockBinding(t,s,this.bind),window.gl.bindBufferBase(window.gl.UNIFORM_BUFFER,this.bind,this.id))}free(){super.free()}}function p(t){return[t.loc.x,t.loc.y,t.loc.z,t.dir.x,t.up.x,t.up.y,t.up.z,t.dir.y,t.right.x,t.right.y,t.right.z,t.dir.z,t.at.x,t.at.y,t.at.z,0,t.frameW,t.frameH,t.projDist,t.projSize]}class C{constructor(){this.setDefault();var t=p(this);this.ubo=new g("CamUBO",4*t.length,2),this.ubo.update(t)}setDefault=()=>{this.loc=_(1),this.at=_(0),this.dir=_(0,0,-1),this.up=_(0,1,0),this.right=_(1,0,0),this.projDist=.1,this.projSize=.1,this.projFarClip=300,this.frameW=this.frameH=30,this.camSet(this.loc,this.at,this.up),this.setProj(this.projSize,this.projDist,this.projFarClip)};camSet=(t,s,i)=>{var a,e,r;this.matrView=(a=t,i=i,e=(e=s).sub(a).norm(),r=(i=e.cross(i).norm()).cross(e),l([[i.x,r.x,-e.x,0],[i.y,r.y,-e.y,0],[i.z,r.z,-e.z,0],[-a.dot(i),-a.dot(r),a.dot(e),1]])),this.loc=t,this.at=s,this.dir=_(-this.matrView.a[0][2],-this.matrView.a[1][2],-this.matrView.a[2][2]),this.up=_(this.matrView.a[0][1],this.matrView.a[1][1],this.matrView.a[2][1]),this.right=_(this.matrView.a[0][0],this.matrView.a[1][0],this.matrView.a[2][0]),void 0!==this.ubo&&this.ubo.update(p(this)),void 0!==this.matrProj&&(this.matrVP=this.matrView.mulMatr(this.matrProj))};setProj=(t,s,i)=>{let a,e;var r,n,h;a=e=t,this.projDist=s,this.projSize=t,this.projFarClip=i,this.frameW>this.frameH?a*=this.frameW/this.frameH:e*=this.frameH/this.frameW,this.matrProj=(s=-a/2,t=a/2,i=-e/2,r=e/2,n=this.projDist,h=this.projFarClip,l([[2*n/(t-s),0,0,0],[0,2*n/(r-i),0,0],[(t+s)/(t-s),(r+i)/(r-i),(h+n)/(n-h),-1],[0,0,2*n*h/(n-h),0]])),this.matrVP=this.matrView.mulMatr(this.matrProj),void 0!==this.ubo&&this.ubo.update(p(this))};setSize=(t,s)=>{this.frameW=t,this.frameH=s,this.setProj(this.projSize,this.projDist,this.projFarClip)}}class X{constructor(t,s){this.x=t,this.y=void 0===s?t:s}}function f(...t){return new X(...t)}class O{constructor(t,s,i,a){this.x=t,this.y=s,this.z=i,this.w=a}}function e(...t){return new O(...t)}class j{constructor(t,s){this.progId=s,this.name=t}}function G(n){return this.load=i=>{const a=[["vert",n.VERTEX_SHADER],["frag",n.FRAGMENT_SHADER]];var t=[];for(let s=0;s<a.length;s++){const r="../bin/shaders/"+i+"/"+a[s][0]+".glsl";t[s]=fetch(r).then(t=>t.text()).then(t=>{a[s][2]=n.createShader(a[s][1]),n.shaderSource(a[s][2],t),n.compileShader(a[s][2]),n.getShaderParameter(a[s][2],n.COMPILE_STATUS)||(t=n.getShaderInfoLog(a[s][2]),console.log(r+":\n"+t))})}const e=this.shaderSize;this.shaders[e]=new j(i,void 0),Promise.all(t).then(()=>{var t,s=n.createProgram();for(let t=0;t<a.length;t++)n.attachShader(s,a[t][2]);n.linkProgram(s),n.getProgramParameter(s,n.LINK_STATUS)||(t=n.getProgramInfoLog(s),console.log(t)),this.shaders[e]=new j(i,s)})},this.add=s=>{for(let t=0;t<this.shaderSize;t++)if(this.shaders[t].name===s)return t;return this.load(s),this.shaderSize++},this.shdGet=t=>t<0||t>=this.shaderSize?this.shaders[0]:this.shaders[t],this.shaderSize=0,this.shaders=[],this.add("default"),this}class M{constructor(t,s,i,a,e,r,n){this.name=t,this.ka=s,this.kd=i,this.ks=a,this.ph=e,this.trans=r,this.shdNo=n;t=[this.ka.x,this.ka.y,this.ka.z,this.ph,this.kd.x,this.kd.y,this.kd.z,this.trans,this.ks.x,this.ks.y,this.ks.z,0];this.uboBuf=new g("MtlUBO",4*t.length,1),this.uboBuf.update(t),this.tex=[-1,-1,-1,-1,-1,-1,-1,-1]}free(){this.uboBuf.free()}}function W(t){return this.getDef=()=>new M("Default",_(.1),_(.9),_(.3),30,1,0),this.add=s=>{for(let t=0;t<this.mtlSize;t++)if(s.name===this.mtls[t])return t;return this.mtls[this.mtlSize]=s,this.mtlSize++},this.get=t=>t<0||t>=this.mtlSize?this.mtls[0]:this.mtls[t],this.apply=t=>{var s=this.get(t),i=I.shd.shdGet(s.shdNo).progId;if(void 0===i)return 0;window.gl.useProgram(i),s.uboBuf.apply(i);let a;for(let t=0;t<s.tex.length;t++)-1!==s.tex[t]?(I.tex.textures[s.tex[t]].isCube?(window.gl.activeTexture(window.gl.TEXTURE0+9),window.gl.bindTexture(window.gl.TEXTURE_CUBE_MAP,I.tex.textures[s.tex[t]].id),-1!==(a=window.gl.getUniformLocation(i,"Cubemap"+t))&&window.gl.uniform1i(a,t)):(window.gl.activeTexture(window.gl.TEXTURE0+t),window.gl.bindTexture(window.gl.TEXTURE_2D,I.tex.textures[s.tex[t]].id),-1!==(a=window.gl.getUniformLocation(i,"Texture"+t))&&window.gl.uniform1i(a,t)),-1!==(a=window.gl.getUniformLocation(i,"IsTexture"+t))&&window.gl.uniform1i(a,1)):-1!==(a=window.gl.getUniformLocation(i,"IsTexture"+t))&&window.gl.uniform1i(a,0);return i},this.free=()=>{for(let t=0;t<this.mtlSize;t++)this.mtls[t].free()},this.mtlSize=0,this.mtls=[],this.add(this.getDef()),this}class T{constructor(t,s,i){this.name=t,this.id=s,this.isCube=void 0!==i&&i}}function V(){return this.textures=[],this.texSize=0,this.add=t=>{const s=this.texSize++,i=window.gl,a=(this.textures[s]=new T(t,i.createTexture()),new Image);return a.src="../bin/textures/"+t,a.onload=()=>{i.bindTexture(i.TEXTURE_2D,this.textures[s].id),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,a),i.generateMipmap(i.TEXTURE_2D),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)},s},this.addImg=(t,s,i,a)=>{var e=this.texSize++,r=window.gl;return this.textures[e]=new T(t,r.createTexture()),this.textures[e].id=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this.textures[e].id),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,i,a,0,r.RGBA,r.UNSIGNED_BYTE,new Uint8Array(s)),r.generateMipmap(r.TEXTURE_2D),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.REPEAT),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.REPEAT),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),e},this.addCubeMap=s=>{const i=this.texSize++,a=window.gl;var e=["PosX","NegX","PosY","NegY","PosZ","NegZ"];this.textures[i]=new T(s,a.createTexture(),!0),a.bindTexture(a.TEXTURE_CUBE_MAP,this.textures[i].id),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_R,a.CLAMP_TO_EDGE);for(let t=0;t<6;t++){var r=s+"/"+e[t]+".png";const n=new Image;n.src="../bin/textures/skyboxes/"+r,n.onload=()=>{a.bindTexture(a.TEXTURE_CUBE_MAP,this.textures[i].id),a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,a.RGBA,a.UNSIGNED_BYTE,n)}}return i},this}let r=[0,0,0,0],n=[0,0,0];function x(s,i){for(let t=0;t<s.length;t++)s[t].n=_(0);if(null!==i)for(let t=0;t+2<i.length;t+=3){var a=s[i[t+1]].p.sub(s[i[t]].p).cross(s[i[t+2]].p.sub(s[i[t]].p)).norm();s[i[t]].n=s[i[t]].n.add(a).norm(),s[i[t+1]].n=s[i[t+1]].n.add(a).norm(),s[i[t+2]].n=s[i[t+2]].n.add(a).norm()}else for(let t=0;t+2<s.length;t+=3){var e=s[t+1].p.sub(s[t].p).cross(s[t+2].p.sub(s[t].p)).norm();s[t].n=s[t].n.add(e).norm(),s[t+1].n=s[t+1].n.add(e).norm(),s[t+2].n=s[t+2].n.add(e).norm()}}class Y{constructor(t,s,i,a){void 0===t?(this.p=_(0),this.t=f(0),this.n=_(0),this.c=e(0)):"object"==typeof t&&void 0===s?(this.p=t.p,this.t=t.t,this.n=t.n,this.c=t.c):(this.p=t,this.t=s,this.n=i,this.c=a)}}function E(...t){return new Y(...t)}function B(s,i){for(let t=0;t<16;t++)s.push(i.a[(t-t%4)/4][t%4])}class v{constructor(t,s,i){var a,e;this.vBuf=this.vA=this.iBuf=0,null!==s&&(a=window.gl.createVertexArray(),window.gl.bindVertexArray(a),e=function(s){if("object"!=typeof s[0])return s;var i=[];for(let t=0;t<s.length;t++)i.push(s[t].p.x),i.push(s[t].p.y),i.push(s[t].p.z),i.push(s[t].t.x),i.push(s[t].t.y),i.push(s[t].n.x),i.push(s[t].n.y),i.push(s[t].n.z),i.push(s[t].c.x),i.push(s[t].c.y),i.push(s[t].c.z),i.push(s[t].c.w);return i}(s),this.vBuf=new L(e),this.vA=a),null!==i?(e=window.gl.createBuffer(),window.gl.bindBuffer(window.gl.ELEMENT_ARRAY_BUFFER,e),window.gl.bufferData(window.gl.ELEMENT_ARRAY_BUFFER,2*i.length,window.gl.STATIC_DRAW),window.gl.bufferData(window.gl.ELEMENT_ARRAY_BUFFER,new Uint32Array(i),window.gl.STATIC_DRAW),this.iBuf=new q(i),this.numOfElements=i.length):this.numOfElements=s.length,this.trans=h(),this.type=t,this.mtlNo=0,[this.minBB,this.maxBB]=function(s){let i,a;if("object"==typeof s[0]){i=_(s[0].p),a=_(s[0].p);for(let t=1;t<s.length;t++)s[t].p.x<i.x?i.x=s[t].p.x:s[t].p.x>a.x&&(a.x=s[t].p.x),s[t].p.y<i.y?i.y=s[t].p.y:s[t].p.y>a.y&&(a.y=s[t].p.y),s[t].p.z<i.z?i.z=s[t].p.z:s[t].p.z>a.z&&(a.z=s[t].p.z)}else{i=_(s[0],s[1],s[2]),a=_(s[0],s[1],s[2]);for(let t=12;t+2<s.length;t+=12)s[t]<i.x?i.x=s[t]:s[t]>a.x&&(a.x=s[t]),s[t+1]<i.y?i.y=s[t+1]:s[t+1]>a.y&&(a.y=s[t+1]),s[t+2]<i.z?i.z=s[t+2]:s[t+2]>a.z&&(a.z=s[t+2])}return[i,a]}(s)}free=()=>{this.vBuf.free(),this.iBuf.free()};draw=t=>{var s,t=this.trans.mulMatr(t),i=t.inverse().transpose(),a=t.mulMatr(m.ds_cam.matrVP),e=I.mtl.apply(this.mtlNo);0!==e&&(B(s=[],t),B(s,i),B(s,a),I.matrixUBO.update(s),I.matrixUBO.apply(e),m.ds_cam.ubo.apply(e),-1!==(t=window.gl.getUniformLocation(e,"Time"))&&window.gl.uniform1f(t,N.localTime),-1!==(t=window.gl.getUniformLocation(e,"AddonI0"))&&window.gl.uniform1i(t,r[0]),-1!==(t=window.gl.getUniformLocation(e,"AddonI1"))&&window.gl.uniform1i(t,r[1]),-1!==(t=window.gl.getUniformLocation(e,"AddonI2"))&&window.gl.uniform1i(t,r[2]),-1!==(t=window.gl.getUniformLocation(e,"AddonI3"))&&window.gl.uniform1i(t,r[3]),-1!==(t=window.gl.getUniformLocation(e,"AddonF0"))&&window.gl.uniform1f(t,n[0]),-1!==(t=window.gl.getUniformLocation(e,"AddonF1"))&&window.gl.uniform1f(t,n[1]),-1!==(t=window.gl.getUniformLocation(e,"AddonF2"))&&window.gl.uniform1f(t,n[2]),window.gl.bindVertexArray(this.vA),this.vBuf.apply(),0===this.iBuf?window.gl.drawArrays(this.type,0,this.numOfElements):(this.iBuf.apply(),window.gl.drawElements(this.type,this.numOfElements,window.gl.UNSIGNED_INT,0)),-1!==(t=window.gl.getAttribLocation(e,"InPos"))&&(window.gl.vertexAttribPointer(t,3,window.gl.FLOAT,!1,48,0),window.gl.enableVertexAttribArray(t)),-1!==(t=window.gl.getAttribLocation(e,"InTexCoord"))&&(window.gl.vertexAttribPointer(t,2,window.gl.FLOAT,!1,48,12),window.gl.enableVertexAttribArray(t)),-1!==(t=window.gl.getAttribLocation(e,"InNormal"))&&(window.gl.vertexAttribPointer(t,3,window.gl.FLOAT,!1,48,20),window.gl.enableVertexAttribArray(t)),-1!==(t=window.gl.getAttribLocation(e,"InColor")))&&(window.gl.vertexAttribPointer(t,4,window.gl.FLOAT,!1,48,32),window.gl.enableVertexAttribArray(t))}}function y(s,i){var a=[];if(null!==i)for(let t=0;t<i.length;t++)a[t]=E(s[i[t]],f(0),_(0),e(0));else for(let t=0;t<s.length;t++)a[t]=E(s[t],f(0),_(0),e(0));return a}let A=!1,R=!1,H=!1,b=!1,U=[],z=[],k=[];z.length=U.length=k.length=256;for(let t=0;t<256;t++)z[t]=k[t]=U[t]=0;function J(t){0===t.button&&(A=!0)}function K(t){0===t.button&&(A=!1)}function Z(t,s){t.preventDefault(),0===t.button?R=s:2===t.button&&(H=s)}function Q(){R=H=!1}function $(t){U[t.keyCode]=z[t.keyCode],z[t.keyCode]=1,k[t.keyCode]=!U[t.keyCode]}function tt(t){U[t.keyCode]=z[t.keyCode],z[t.keyCode]=0,k[t.keyCode]=0}function P(a){if(void 0!==m.ds_cam){let i=m.ds_cam.at.sub(m.ds_cam.loc).len();var e=(m.ds_cam.loc.y-m.ds_cam.at.y)/i,r=Math.sqrt(1-e*e),n=i*r,h=(m.ds_cam.loc.z-m.ds_cam.at.z)/n,n=(m.ds_cam.loc.x-m.ds_cam.at.x)/n;let t=d(Math.atan2(n,h)),s=d(Math.atan2(r,e));if(R&&(t-=N.globalDeltaTime*a.movementX*10,s-=N.globalDeltaTime*a.movementY*10),i+=N.globalDeltaTime*(void 0===a.deltaY?0:a.deltaY)/20*i,s<.1?s=.1:178.9<s&&(s=178.9),i<.1&&(i=.1),H){let t,s;s=t=m.ds_cam.projSize,window.gl.canvas.width>window.gl.canvas.height?t*=window.gl.canvas.width/window.gl.canvas.height:t*=window.gl.canvas.height/window.gl.canvas.width;n=-(a.movementX*t/window.gl.canvas.width*i)/m.ds_cam.projDist,h=a.movementY*s/window.gl.canvas.height*i/m.ds_cam.projDist,r=m.ds_cam.right.mulNum(n).add(m.ds_cam.up.mulNum(h));m.ds_cam.at=m.ds_cam.at.add(r),m.ds_cam.loc=m.ds_cam.loc.add(r)}m.ds_cam.camSet(_(0,i,0).pointTransform(c(s).mulMatr(w(t)).mulMatr(u(m.ds_cam.at))),m.ds_cam.at,_(0,1,0)),a.preventDefault()}}function st(){var t=document.getElementById("windowW"),s=document.getElementById("windowWText"),s=(window.gl.canvas.width=parseInt(t.value),s.innerHTML="FrameW:"+t.value,document.getElementById("windowH")),t=document.getElementById("windowHText");window.gl.canvas.height=parseInt(s.value),t.innerHTML="FrameH:"+s.value,m.ds_cam.setSize(window.gl.canvas.width,window.gl.canvas.height),window.gl.viewport(0,0,window.gl.canvas.width,window.gl.canvas.height)}function it(t){N.isPause=t.checked}class at{constructor(t){this.numOfPrims=t,this.trans=h(),this.minBB=this.maxBB=_(0),this.prims=[]}draw=t=>{var s=this.trans.mulMatr(t);r[0]=this.numOfPrims;for(let t=0;t<this.numOfPrims;t++)1===I.mtl.get(this.prims[t].mtlNo).trans&&(r[1]=t,this.prims[t].draw(s));window.gl.enable(window.gl.CULL_FACE),window.gl.cullFace(window.gl.FRONT);for(let t=0;t<this.numOfPrims;t++)1!==I.mtl.get(this.prims[t].mtlNo).trans&&(r[1]=t,this.prims[t].draw(s));window.gl.cullFace(window.gl.BACK);for(let t=0;t<this.numOfPrims;t++)1!==I.mtl.get(this.prims[t].mtlNo).trans&&(r[1]=t,this.prims[t].draw(s));window.gl.disable(window.gl.CULL_FACE)}}async function et(t){var s=await(await fetch(t)).arrayBuffer(),i=new Uint8Array(s);let a=0;if("G3DM"!==i.slice(a,a+=4).reduce((t,s)=>t+String.fromCharCode(s),""))return null;var[e,r,n]=new Uint32Array(s.slice(a,a+=12)),h=new at(e);for(let t=0;t<e;t++){var[l,o,m]=new Uint32Array(s.slice(a,a+=12)),l=new Float32Array(s.slice(a,a+=48*l)),o=new Uint32Array(s.slice(a,a+=4*o));h.prims.push(new v(window.gl.TRIANGLES,l,o)),h.prims[t].mtlNo=I.mtl.mtlSize+m,0===t?(h.minBB=h.prims[0].minBB,h.maxBB=h.prims[0].maxBB):(h.minBB.x>h.prims[t].minBB.x&&(h.minBB.x=h.prims[t].minBB.x),h.maxBB.x<h.prims[t].maxBB.x&&(h.maxBB.x=h.prims[t].maxBB.x),h.minBB.y>h.prims[t].minBB.y&&(h.minBB.y=h.prims[t].minBB.y),h.maxBB.y<h.prims[t].maxBB.y&&(h.maxBB.y=h.prims[t].maxBB.y),h.minBB.z>h.prims[t].minBB.z&&(h.minBB.z=h.prims[t].minBB.z),h.maxBB.z<h.prims[t].maxBB.z&&(h.maxBB.z=h.prims[t].maxBB.z))}for(let t=0;t<r;t++){var d=i.slice(a,a+=300).reduce((t,s)=>t+(0==s?"":String.fromCharCode(s)),""),u=new Float32Array(s.slice(a,a+=44)),c=new Int32Array(s.slice(a,a+=32)),w=new M(d,_(u[0],u[1],u[2]),_(u[3],u[4],u[5]),_(u[6],u[7],u[8]),u[9],u[10],0);for(let t=0;t<8;t++)w.tex[t]=-1==c[t]?-1:c[t]+I.tex.texSize;I.mtl.add(w),a+=304}for(let t=0;t<n;t++){var g=i.slice(a,a+=300).reduce((t,s)=>t+(0==s?"":String.fromCharCode(s)),""),[p,f,T]=new Uint32Array(s.slice(a,a+=12)),x=i.slice(a,a+=p*f*T);for(let t=0;t<x.length;t+=4){var E=x[t];x[t]=x[t+2],x[t+2]=E}I.tex.addImg(g,x,p,f)}return h}class S{constructor(){this.init=this.close=this.response=this.render=()=>{}}}function rt(){return this.units=[],this.addUnit=t=>{this.units.push(t),t.init()},this.render=()=>{st(),N.response();for(let t=0;t<this.units.length;t++)this.units[t].response();I.start();for(let t=0;t<this.units.length;t++)this.units[t].render()},this}class nt extends S{constructor(t){var s,i;super(),this.prim=(t=t,s=Math.sqrt(2),i=Math.sqrt(6),x(i=y([_(0,1,0),_(-s/3,-1/3,-i/3),_(-s/3,-1/3,i/3),_(2*s/3,-1/3,0)],[0,1,2,0,2,3,0,3,1,1,2,3]),null),(s=new v(window.gl.TRIANGLES,i,null)).trans=t,s),this.prim.mtlNo=I.mtl.add(new M("Gold",_(.24725,.1995,.0745),_(.75164,.60648,.22648),_(.628281,.555802,.366065),51.2,1,0))}render=()=>{this.prim.draw(t(100*N.localTime).mulMatr(c(100*N.localTime))),this.prim.draw(u(_(0,2,0)))}}class ht extends S{constructor(t){var s;super(),this.prim=(t=t,x(s=y([_(-(s=1/Math.sqrt(3)),s,-s),_(s,s,-s),_(s,-s,-s),_(-s,-s,-s),_(-s,s,s),_(s,s,s),_(s,-s,s),_(-s,-s,s)],[0,1,2,0,2,3,2,1,5,2,5,6,3,2,6,3,6,7,0,3,7,0,7,4,1,0,4,1,4,5,6,5,4,6,4,7]),null),(s=new v(window.gl.TRIANGLES,s,null)).trans=t,s),this.prim.mtlNo=I.mtl.add(new M("Silver",_(.19225),_(.50754),_(.508273),51.2,1,0))}render=()=>{this.prim.draw(t(100*N.localTime).mulMatr(c(100*N.localTime)).mulMatr(u(_(2,0,0)))),this.prim.draw(u(_(2,2,0)))}}class lt extends S{constructor(t){var s;super(),this.prim=(t=t,x(s=y([_(-1,0,0),_(0,0,1),_(1,0,0),_(0,0,-1),_(0,1,0),_(0,-1,0)],[0,1,4,1,2,4,2,3,4,3,0,4,0,1,5,1,2,5,2,3,5,3,0,5]),null),(s=new v(window.gl.TRIANGLES,s,null)).trans=t,s),this.prim.mtlNo=I.mtl.add(new M("Obsidian",_(.05375,.05,.06625),_(.18275,.17,.22525),_(.332741,.328634,.346435),38.4,1,0))}render=()=>{this.prim.draw(t(100*N.localTime).mulMatr(c(100*N.localTime)).mulMatr(u(_(4,0,0)))),this.prim.draw(u(_(4,2,0)))}}class ot extends S{constructor(t){super(),this.prim=function(t){var s=[_(0,-1,0),_(0,1,0),_(-2/Math.sqrt(5),-1/Math.sqrt(5),0),_(2/Math.sqrt(5),1/Math.sqrt(5),0),_(.5+.5/Math.sqrt(5),-1/Math.sqrt(5),-Math.sqrt(.1*(5-Math.sqrt(5)))),_(.5+.5/Math.sqrt(5),-1/Math.sqrt(5),Math.sqrt(.1*(5-Math.sqrt(5)))),_(-.1*(5+Math.sqrt(5)),1/Math.sqrt(5),-Math.sqrt(.1*(5-Math.sqrt(5)))),_(-.1*(5+Math.sqrt(5)),1/Math.sqrt(5),Math.sqrt(.1*(5-Math.sqrt(5)))),_(.1*Math.sqrt(5)-.5,-1/Math.sqrt(5),-Math.sqrt(.1*(5+Math.sqrt(5)))),_(.1*Math.sqrt(5)-.5,-1/Math.sqrt(5),Math.sqrt(.1*(5+Math.sqrt(5)))),_(.5-.1*Math.sqrt(5),1/Math.sqrt(5),-Math.sqrt(.1*(5+Math.sqrt(5)))),_(.5-.1*Math.sqrt(5),1/Math.sqrt(5),Math.sqrt(.1*(5+Math.sqrt(5))))];let i=[0,8,2,0,2,9,0,9,5,0,5,4,0,4,8,1,3,10,1,10,6,1,6,7,1,7,11,1,11,3,3,4,5,10,4,8,6,8,2,7,2,9,11,9,5,4,10,3,8,10,6,2,6,7,9,7,11,5,11,3];var a=[];for(let t=0;t+2<i.length;t+=3){var e=_(s[i[t]].x+s[i[t+1]].x+s[i[t+2]].x,s[i[t]].y+s[i[t+1]].y+s[i[t+2]].y,s[i[t]].z+s[i[t+1]].z+s[i[t+2]].z).divNum(3);a.push(e)}var r=o(_(1/a[0].len()));for(let t=0;t<a.length;t++)a[t]=a[t].pointTransform(r);var n=y(a,i=[0,1,2,0,2,3,0,3,4,1,2,13,2,13,14,13,14,18,0,1,12,1,12,13,12,13,17,4,0,11,0,11,12,11,12,16,3,4,10,4,10,11,10,11,15,2,3,14,3,14,10,14,10,19,19,14,18,18,19,9,8,18,9,18,13,17,17,18,8,7,17,8,17,12,16,16,17,7,6,16,7,16,11,15,15,16,6,5,15,6,15,10,19,19,15,5,9,19,5,5,6,7,5,7,8,5,8,9]);return x(n,null),(n=new v(window.gl.TRIANGLES,n,null)).trans=t,n}(t),this.prim.mtlNo=I.mtl.add(new M("Bronze",_(.2125,.1275,.054),_(.714,.4284,.18144),_(.393548,.271906,.166721),25.6,1,0))}render=()=>{this.prim.draw(t(100*N.localTime).mulMatr(c(100*N.localTime)).mulMatr(u(_(6,0,0)))),this.prim.draw(u(_(6,2,0)))}}class mt extends S{constructor(t){var s;super(),this.prim=(t=t,x(s=y([_(0,-1,0),_(0,1,0),_(-2/Math.sqrt(5),-1/Math.sqrt(5),0),_(2/Math.sqrt(5),1/Math.sqrt(5),0),_(.5+.5/Math.sqrt(5),-1/Math.sqrt(5),-Math.sqrt(.1*(5-Math.sqrt(5)))),_(.5+.5/Math.sqrt(5),-1/Math.sqrt(5),Math.sqrt(.1*(5-Math.sqrt(5)))),_(-.1*(5+Math.sqrt(5)),1/Math.sqrt(5),-Math.sqrt(.1*(5-Math.sqrt(5)))),_(-.1*(5+Math.sqrt(5)),1/Math.sqrt(5),Math.sqrt(.1*(5-Math.sqrt(5)))),_(.1*Math.sqrt(5)-.5,-1/Math.sqrt(5),-Math.sqrt(.1*(5+Math.sqrt(5)))),_(.1*Math.sqrt(5)-.5,-1/Math.sqrt(5),Math.sqrt(.1*(5+Math.sqrt(5)))),_(.5-.1*Math.sqrt(5),1/Math.sqrt(5),-Math.sqrt(.1*(5+Math.sqrt(5)))),_(.5-.1*Math.sqrt(5),1/Math.sqrt(5),Math.sqrt(.1*(5+Math.sqrt(5))))],[0,8,2,0,2,9,0,9,5,0,5,4,0,4,8,1,3,10,1,10,6,1,6,7,1,7,11,1,11,3,3,4,5,10,4,8,6,8,2,7,2,9,11,9,5,4,10,3,8,10,6,2,6,7,9,7,11,5,11,3]),null),(s=new v(window.gl.TRIANGLES,s,null)).trans=t,s),this.prim.mtlNo=I.mtl.add(new M("Emerald",_(.0215,.1745,.0215),_(.07568,.61424,.07568),_(.633,.727811,.633),76.8,1,0))}render=()=>{this.prim.draw(t(100*N.localTime).mulMatr(c(100*N.localTime)).mulMatr(u(_(8,0,0)))),this.prim.draw(u(_(8,2,0)))}}class dt extends S{constructor(i){super();var t=I.primLoad("../bin/models/cow.obj");this.prim=null,t.then(t=>{this.prim=t,this.prim.mtlNo=I.mtl.add(new M("Cow material",I.mtl.mtls[0].ka,I.mtl.mtls[0].kd,I.mtl.mtls[0].ks,I.mtl.mtls[0].ph,1,I.shd.add("cow")));var t=this.prim.maxBB.sub(this.prim.minBB),s=(s=t.x>t.y?t.x:t.y)>t.z?s:t.z;this.prim.trans=o(_(1/s,1/s,1/s).mulNum(1.5)).mulMatr(i)})}render=()=>{null!==this.prim&&this.prim.draw(h())}}const ut=_(0,-9.80665,0);class ct{constructor(t){this.shells=[],this.prs=t}add=(t,s)=>{this.shells.push({pos:t,speed:s,time:0})};update=()=>{for(let t=0;t<this.shells.length;t++)30<=this.shells[t].time?this.shells.splice(t,1):(this.shells[t].pos=this.shells[t].pos.add(this.shells[t].speed.mulNum(N.localDeltaTime)).add(ut.mulNum(N.localDeltaTime*N.localDeltaTime/2)),this.shells[t].speed.y-=9.80665*N.localDeltaTime,this.shells[t].speed.time+=N.localDeltaTime)};draw=()=>{for(let t=0;t<this.shells.length;t++){var s=this.shells[t].speed.len(),i=this.shells[t].speed.y/s,a=Math.sqrt(1-i*i),s=s*a,e=this.shells[t].speed.z/s,s=this.shells[t].speed.x/s,s=d(Math.atan2(s,e)),e=d(Math.atan2(a,i));this.prs.draw(o(_(.003)).mulMatr(c(180)).mulMatr(c(e)).mulMatr(w(s)).mulMatr(u(this.shells[t].pos)))}}}class wt extends S{constructor(t){super(),this.tank=null,this.pos=t;t=et("../bin/models/Sherman.g3dm"),this.shells=null,t.then(t=>{this.tank=t;var s=I.shd.add("tank");for(let t=0;t<this.tank.numOfPrims;t++)I.mtl.get(this.tank.prims[t].mtlNo).shdNo=s;t=this.tank.maxBB.y-this.tank.minBB.y;this.matrScale=o(_(2.743/t)),this.tank.trans=this.matrScale.mulMatr(u(this.pos)),et("../bin/models/bomb.g3dm").then(t=>{this.shells=new ct(t)})}),this.cam=!1,this.anglWheels=this.anglTower=this.anglGun=0,this.anglY=0,this.reloading=0,this.reloadTime=3,t=[E(_(-1,1,0),f(0),_(0),e(0)),E(_(-1,-1,0),f(0),_(0),e(0)),E(_(1,1,0),f(0),_(0),e(0)),E(_(1,-1,0),f(0),_(0),e(0))],this.reloadCirc=new v(window.gl.TRIANGLE_STRIP,t,null),t=new M("Reload tank material",I.mtl.mtls[0].ka,I.mtl.mtls[0].kd,I.mtl.mtls[0].ks,I.mtl.mtls[0].ph,1,0);t.shdNo=I.shd.add("tankReload"),this.reloadCirc.mtlNo=I.mtl.add(t)}ctrlTank=t=>{let s=m.ds_cam.at.sub(m.ds_cam.loc).len();var i=(m.ds_cam.loc.y-m.ds_cam.at.y)/s,a=Math.sqrt(1-i*i),e=s*a,r=(m.ds_cam.loc.z-m.ds_cam.at.z)/e,e=(m.ds_cam.loc.x-m.ds_cam.at.x)/e,e=d(Math.atan2(e,r));let n=d(Math.atan2(a,i));e-=N.globalDeltaTime*t.movementX*10,n-=N.globalDeltaTime*t.movementY*10,t.preventDefault(),s+=N.globalDeltaTime*((void 0===t.deltaY?0:t.deltaY)+20*(z[34]-z[33]))/20*s,n<.1?n=.1:178.9<n&&(n=178.9),s<.1&&(s=.1);r=this.tank.prims[14].maxBB.add(this.tank.prims[14].minBB).divNum(2).add(_(0,.75,0)).pointTransform(this.tank.trans),a=_(0,s,0).pointTransform(c(n).mulMatr(w(e)).mulMatr(u(r)));m.ds_cam.camSet(a,r,_(0,1,0)),t.preventDefault()};response=()=>{if(null!==this.tank){if(b!==this.cam){this.cam=b;var r=document.getElementById("dsCan");if(b){r.removeEventListener("mousemove",P),r.removeEventListener("mousewheel",P),r.addEventListener("mousemove",this.ctrlTank),r.addEventListener("mousewheel",this.ctrlTank),camCtrlCan=this.ctrlTank;let t=m.ds_cam.at.sub(m.ds_cam.loc).len();var n=(m.ds_cam.loc.y-m.ds_cam.at.y)/t,h=Math.sqrt(1-n*n),l=t*h,o=(m.ds_cam.loc.z-m.ds_cam.at.z)/l,l=(m.ds_cam.loc.x-m.ds_cam.at.x)/l,l=d(Math.atan2(l,o));let s=d(Math.atan2(h,n));s<.1?s=.1:178.9<s&&(s=178.9),t<.1&&(t=.1);o=this.tank.prims[14].maxBB.add(this.tank.prims[14].minBB).divNum(2).add(_(0,.75,0)).pointTransform(this.tank.trans),h=_(0,t,0).pointTransform(c(s).mulMatr(w(l)).mulMatr(u(o)));m.ds_cam.camSet(h,o,_(0,1,0))}else r.removeEventListener("mousemove",this.ctrlTank),r.removeEventListener("mousewheel",this.ctrlTank),r.addEventListener("mousemove",P),r.addEventListener("mousewheel",P),camCtrlCan=P}if(b){n=_(this.tank.prims[14].maxBB.x,this.tank.prims[14].maxBB.y,this.tank.prims[14].minBB.z);this.pos=this.pos.add(this.tank.prims[14].maxBB.pointTransform(this.tank.trans).sub(n.pointTransform(this.tank.trans)).mulNum(5*(z[87]-z[83])*N.localDeltaTime)),this.anglY+=(z[87]-z[83]!=0?.5*(z[87]-z[83]):1)*(z[65]-z[68])*80*N.localDeltaTime;let t=(z[87]-z[83])*N.localDeltaTime*1e3,s=(0===t&&(t=(z[68]-z[65])*N.localDeltaTime*1e3),this.anglWheels+=t,this.tank.trans=this.matrScale.mulMatr(w(this.anglY)).mulMatr(u(this.pos)),m.ds_cam.at.sub(m.ds_cam.loc).len());l=(m.ds_cam.loc.y-m.ds_cam.at.y)/s,h=Math.sqrt(1-l*l),o=s*h,r=(m.ds_cam.loc.z-m.ds_cam.at.z)/o,n=(m.ds_cam.loc.x-m.ds_cam.at.x)/o,o=d(Math.atan2(n,r));let i=d(Math.atan2(h,l));i<.1?i=.1:178.9<i&&(i=178.9),s<.1&&(s=.1);n=this.tank.prims[14].maxBB.add(this.tank.prims[14].minBB).divNum(2).add(_(0,.75,0)).pointTransform(this.tank.trans),r=_(0,s,0).pointTransform(c(i).mulMatr(w(o)).mulMatr(u(n))),h=(m.ds_cam.camSet(r,n,_(0,1,0)),this.tank.prims[15].maxBB.add(this.tank.prims[15].minBB).divNum(2));null!==this.shells&&A&&this.reloading<=0&&(l=h.pointTransform(this.tank.prims[15].trans.mulMatr(this.tank.trans)).sub(_(h.x,h.y,this.tank.prims[15].minBB.z).pointTransform(this.tank.prims[15].trans.mulMatr(this.tank.trans))).norm().mulNum(50),o=h.pointTransform(this.tank.prims[15].trans.mulMatr(this.tank.trans)),this.shells.add(o,l),this.reloading=this.reloadTime);let a=h.pointTransform(this.tank.prims[14].trans.mulMatr(this.tank.trans));r=m.ds_cam.loc.sub(a).dot(m.ds_cam.up)/m.ds_cam.up.len2();let e=m.ds_cam.up.mulNum(r).add(a);n=e.sub(m.ds_cam.at).dot(m.ds_cam.dir)/(e.sub(m.ds_cam.at).len()*m.ds_cam.dir.len()),o=d(Math.acos(Math.max(Math.min(n,1),-1))),r=(Math.abs(o)>30*N.localDeltaTime?(l=e.sub(m.ds_cam.at).dot(m.ds_cam.right)/(e.sub(m.ds_cam.at).len()*m.ds_cam.right.len()),this.anglTower+=(0<l?1:-1)*N.localDeltaTime*30):(l=e.sub(m.ds_cam.at).dot(m.ds_cam.right)/(e.sub(m.ds_cam.at).len()*m.ds_cam.right.len()),this.anglTower+=(0<l?1:-1)*o),a=h.pointTransform(this.tank.prims[15].trans.mulMatr(this.tank.trans)),r=m.ds_cam.loc.sub(a).dot(m.ds_cam.right)/m.ds_cam.right.len2(),e=a.add(m.ds_cam.right.mulNum(r)),a=_(h.x,h.y,this.tank.prims[15].minBB.z).pointTransform(this.tank.prims[15].trans.mulMatr(this.tank.trans)),m.ds_cam.loc.sub(a).dot(m.ds_cam.right)/m.ds_cam.right.len2()),l=m.ds_cam.right.mulNum(r).add(a),n=e.sub(l).dot(m.ds_cam.dir)/(e.sub(l).len()*m.ds_cam.dir.len());o=d(Math.acos(Math.max(Math.min(n,1),-1))),Math.abs(o)>10*N.localDeltaTime&&(h=e.sub(l).dot(m.ds_cam.up)/(e.sub(l).len()*m.ds_cam.up.len()),this.anglGun+=(0<h?-1:1)*N.localDeltaTime*10,30<this.anglGun?this.anglGun=30:this.anglGun<-10&&(this.anglGun=-10))}else this.anglTower+=30*N.localDeltaTime*0;0<this.reloading&&(this.reloading-=N.localDeltaTime);var r=this.tank.prims[14].maxBB.add(this.tank.prims[14].minBB).divNum(2),n=this.tank.prims[15].maxBB.add(this.tank.prims[15].minBB).divNum(2),o=(n.z=this.tank.prims[15].minBB.z,this.tank.prims[16].maxBB.add(this.tank.prims[16].minBB).divNum(2)),s=u(r.neg()).mulMatr(w(this.anglTower)).mulMatr(u(r)),l=u(n.neg()).mulMatr(c(-this.anglGun)).mulMatr(u(n)),h=u(o.neg()).mulMatr(c(this.anglWheels)).mulMatr(u(o));for(let t=0;t<=3;t++)this.tank.prims[t].trans=s;for(let t=5;t<=6;t++)this.tank.prims[t].trans=s;this.tank.prims[14].trans=s,this.tank.prims[15].trans=l.mulMatr(s),this.tank.prims[16].trans=h,null!==this.shells&&this.shells.update()}};render=()=>{null!==this.tank&&(n[0]=s(this.anglWheels),n[1]=Math.cos(n[0]),n[2]=Math.sin(n[0]),r[2]=z[87]-z[83],r[3]=z[65]-z[68],this.tank.draw(h()),null!==this.shells&&this.shells.draw(),b)&&(n[0]=1-Math.max(this.reloading,0)/this.reloadTime,this.reloadCirc.draw(h()))}}class gt extends S{constructor(t){super();var s=[E(_(-1,1,0),f(0),_(0),e(0)),E(_(-1,-1,0),f(0),_(0),e(0)),E(_(1,1,0),f(0),_(0),e(0)),E(_(1,-1,0),f(0),_(0),e(0))],s=(this.prim=new v(window.gl.TRIANGLE_STRIP,s,null),new M("Sky material",I.mtl.mtls[0].ka,I.mtl.mtls[0].kd,I.mtl.mtls[0].ks,I.mtl.mtls[0].ph,1,0));s.tex[0]=I.tex.add(t),s.shdNo=I.shd.add("sky"),this.prim.mtlNo=I.mtl.add(s)}render=()=>{window.gl.depthMask(!1),this.prim.draw(h()),window.gl.depthMask(!0)}}class pt extends S{constructor(){super();var t=[E(_(-1e3,0,-1e3),f(0),_(0,1,0),e(0)),E(_(-1e3,0,1e3),f(0),_(0,1,0),e(0)),E(_(1e3,0,-1e3),f(0),_(0,1,0),e(0)),E(_(1e3,0,1e3),f(0),_(0,1,0),e(0))];this.prim=new v(window.gl.TRIANGLE_STRIP,t,null),this.prim.mtlNo=0}render=()=>{this.prim.draw(h())}}m.ds_cam=void 0;let I=new function(){return this.can=document.getElementById("dsCan"),this.gl=this.can.getContext("webgl2"),Object.defineProperty(window,"gl",{get:()=>(null!=this._gl&&null!=this._gl||(this.canvas=document.getElementById("dsCan"),this._gl=this.canvas.getContext("webgl2")),this._gl),set:t=>{this._gl=t}}),this.shd=new G(this.gl),this.mtl=new W(this.gl),this.tex=new V,this.matrixUBO=new g("MatrixUBO",192,0),this.gl.clearColor(.28,.47,.8,1),this.gl.enable(this.gl.DEPTH_TEST),this.start=()=>{this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.clear(this.gl.DEPTH_BUFFER_BIT),this.gl.enable(this.gl.DEPTH_TEST)},this.close=()=>{this.mtl.free()},this.primLoad=s=>new Promise((n,t)=>{let h=[],l=[],o,m;fetch(s).then(t=>t.text()).then(t=>{var s=t.split("\n");for(let t=0;t<s.length;t++)"v"===s[t].split(" ")[0]&&o++;for(let t=0;t<s.length;t++){var e=s[t].split(" ");if("v"===e[0]){var i=parseFloat(e[1]),a=parseFloat(e[2]),r=parseFloat(e[3]);h.push(E(_(i,a,r),f(0),_(0),_(0)))}else if("f"==e[0]){let s=0,i=0,a=0;for(let t=1;t<e.length;t++)(m=parseInt(e[t]))<0?m+=o:m--,0===s?i=m:a=(1===s||(l.push(i),l.push(a),l.push(m)),m),s++}}x(h,l),n(new v(gl.TRIANGLES,h,l))})}),this},N=new function(){const i=()=>{var t=new Date;return t.getMilliseconds()/1e3+t.getSeconds()+60*t.getMinutes()};return this.response=(t=null)=>{var s=i();this.globalTime=s,this.globalDeltaTime=s-this.oldTime,this.isPause?(this.localDeltaTime=0,this.pauseTime+=s-this.oldTime):(this.localDeltaTime=this.globalDeltaTime,this.localTime=s-this.pauseTime-this.startTime),this.frameCounter++,3<s-this.oldTimeFPS&&(this.FPS=this.frameCounter/(s-this.oldTimeFPS),this.oldTimeFPS=s,this.frameCounter=0,null!=t)&&(document.getElementById(t).innerHTML=this.getFPS()),this.oldTime=s,document.getElementById("fps").innerHTML="FPS:"+this.getFPS()},this.getFPS=()=>this.FPS.toFixed(3),this.globalTime=this.localTime=i(),this.globalDeltaTime=this.localDeltaTime=0,this.startTime=this.oldTime=this.oldTimeFPS=this.globalTime,this.frameCounter=0,this.isPause=!1,this.FPS=30,this.pauseTime=0,this};window.addEventListener("load",()=>{var t,s,i,a=sessionStorage.getItem("camera");a?(a=JSON.parse(a),m.ds_cam=new C,t=_(a.loc),s=_(a.at),i=a.up,m.ds_cam.camSet(t,s,i),m.ds_cam.setProj(a.projSize,a.projDist,a.projFarClip),m.ds_cam.setSize(a.frameW,a.frameH)):(m.ds_cam=new C,m.ds_cam.setSize(window.gl.canvas.width,window.gl.canvas.height),m.ds_cam.camSet(_(5),_(2.5,0,0),_(0,1,0)));let e=document.getElementById("dsCan"),r=(e.addEventListener("mousemove",P),e.addEventListener("mousewheel",P),window.addEventListener("keydown",async t=>{48!==t.keyCode||document.pointerLockElement||await e.requestPointerLock({unadjustedMovement:!0})}),window.addEventListener("keydown",$),window.addEventListener("keyup",tt),window.addEventListener("mousedown",J),window.addEventListener("mouseup",K),mouseOutCan=Q,mouseChangeCan=Z,setPauseCheckbox=it,camCtrlCan=P,new rt);r.addUnit(new gt("starSkytex.png")),r.addUnit(new nt(h())),r.addUnit(new ht(h())),r.addUnit(new lt(h())),r.addUnit(new ot(h())),r.addUnit(new mt(h())),r.addUnit(new dt(u(_(-2,0,0)))),r.addUnit(new wt(_(-4,0,0))),r.addUnit(new pt);const n=()=>{st(),r.render(),k[80]&&(N.isPause=!N.isPause,document.getElementById("pause").checked=N.isPause),k[82]&&m.ds_cam.camSet(_(5),_(2.5,0,0),_(0,1,0)),k[48]&&(b=!0),k[27]&&(b=!1),sessionStorage.setItem("camera",JSON.stringify(m.ds_cam)),window.requestAnimationFrame(n)};n()}),m.dsRnd=I,m.myTimer=N}({});
